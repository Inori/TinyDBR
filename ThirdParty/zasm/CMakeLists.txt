# This file is automatically generated from cmake.toml - DO NOT EDIT
# See https://github.com/build-cpp/cmkr for more information

cmake_minimum_required(VERSION 3.15)

if(CMAKE_SOURCE_DIR STREQUAL CMAKE_BINARY_DIR)
	message(FATAL_ERROR "In-tree builds are not supported. Run CMake from a separate directory: cmake -B build")
endif()

# Regenerate CMakeLists.txt automatically in the root project
set(CMKR_ROOT_PROJECT OFF)
if(CMAKE_CURRENT_SOURCE_DIR STREQUAL CMAKE_SOURCE_DIR)
	set(CMKR_ROOT_PROJECT ON)

	# Bootstrap cmkr
	include(cmkr.cmake OPTIONAL RESULT_VARIABLE CMKR_INCLUDE_RESULT)
	if(CMKR_INCLUDE_RESULT)
		cmkr()
	endif()

	# Enable folder support
	set_property(GLOBAL PROPERTY USE_FOLDERS ON)
endif()

# Create a configure-time dependency on cmake.toml to improve IDE support
if(CMKR_ROOT_PROJECT)
	configure_file(cmake.toml cmake.toml COPYONLY)
endif()

# Options
option(ZASM_BUILD_TESTS OFF)
option(ZYDIS_BUILD_EXAMPLES OFF)
option(ZYDIS_BUILD_TOOLS OFF)
option(INSTALL_GTEST OFF)
option(BUILD_GMOCK OFF)

project(zasm
	LANGUAGES
		CXX
)

include(FetchContent)

message(STATUS "Fetching Zydis (91742f4)...")
FetchContent_Declare(
	Zydis
	GIT_REPOSITORY
		https://github.com/zyantific/zydis
	GIT_TAG
		91742f4
)
FetchContent_MakeAvailable(Zydis)

message(STATUS "Fetching GTest (release-1.11.0)...")
FetchContent_Declare(
	GTest
	GIT_REPOSITORY
		https://github.com/google/googletest
	GIT_TAG
		release-1.11.0
)
FetchContent_MakeAvailable(GTest)

# Target zasm
set(CMKR_TARGET zasm)
set(zasm_SOURCES "")

list(APPEND zasm_SOURCES
	"src/zasm/src/assembler/assembler.cpp"
	"src/zasm/src/assembler/assembler.instructions.cpp"
	"src/zasm/src/decoder/decoder.cpp"
	"src/zasm/src/encoder/encoder.cpp"
	"src/zasm/src/encoder/generator.cpp"
	"src/zasm/src/program/data.cpp"
	"src/zasm/src/program/program.cpp"
	"src/zasm/src/program/program.serialization.cpp"
	"src/zasm/src/zasm.cpp"
	"include/zasm/assembler/assembler.hpp"
	"include/zasm/core/bitsize.hpp"
	"include/zasm/core/enumflags.hpp"
	"include/zasm/core/errors.hpp"
	"include/zasm/core/expected.hpp"
	"include/zasm/core/math.hpp"
	"include/zasm/core/objectpool.hpp"
	"include/zasm/core/stringpool.hpp"
	"include/zasm/decoder/decoder.hpp"
	"include/zasm/encoder/encoder.hpp"
	"include/zasm/program/data.hpp"
	"include/zasm/program/immediate.hpp"
	"include/zasm/program/instruction.hpp"
	"include/zasm/program/label.hpp"
	"include/zasm/program/memory.hpp"
	"include/zasm/program/node.hpp"
	"include/zasm/program/operand.hpp"
	"include/zasm/program/program.hpp"
	"include/zasm/program/register.hpp"
	"include/zasm/program/section.hpp"
	"include/zasm/zasm.hpp"
)

list(APPEND zasm_SOURCES
	cmake.toml
)

set(CMKR_SOURCES ${zasm_SOURCES})
add_library(zasm STATIC)

if(zasm_SOURCES)
	target_sources(zasm PRIVATE ${zasm_SOURCES})
endif()

source_group(TREE ${CMAKE_CURRENT_SOURCE_DIR} FILES ${zasm_SOURCES})

add_library(zasm::zasm ALIAS zasm)
target_compile_features(zasm PUBLIC
	cxx_std_17
)

target_include_directories(zasm PUBLIC
	include
)

target_link_libraries(zasm PUBLIC
	Zydis
)

unset(CMKR_TARGET)
unset(CMKR_SOURCES)

# Target tests
if(ZASM_BUILD_TESTS) # tests
	set(CMKR_TARGET tests)
	set(tests_SOURCES "")

	list(APPEND tests_SOURCES
		"src/tests/main.cpp"
		"src/tests/tests/tests.assembler.cpp"
		"src/tests/tests/tests.instructions.x64.cpp"
		"src/tests/tests/tests.program.cpp"
		"src/tests/tests/tests.registers.cpp"
		"src/tests/tests/tests.sections.cpp"
		"src/tests/tests/tests.serialization.cpp"
		"src/tests/tests/tests.stringpool.cpp"
		"src/tests/testutils.cpp"
		"src/tests/instructiontest.hpp"
		"src/tests/testutils.hpp"
	)

	list(APPEND tests_SOURCES
		cmake.toml
	)

	set(CMKR_SOURCES ${tests_SOURCES})
	add_executable(tests)

	if(tests_SOURCES)
		target_sources(tests PRIVATE ${tests_SOURCES})
	endif()

	get_directory_property(CMKR_VS_STARTUP_PROJECT DIRECTORY ${PROJECT_SOURCE_DIR} DEFINITION VS_STARTUP_PROJECT)
	if(NOT CMKR_VS_STARTUP_PROJECT)
		set_property(DIRECTORY ${PROJECT_SOURCE_DIR} PROPERTY VS_STARTUP_PROJECT tests)
	endif()

	source_group(TREE ${CMAKE_CURRENT_SOURCE_DIR} FILES ${tests_SOURCES})

	if(MSVC) # msvc
		target_compile_options(tests PRIVATE
			"/bigobj"
		)
	endif()

	target_link_libraries(tests PRIVATE
		zasm::zasm
		GTest::gtest
	)

	unset(CMKR_TARGET)
	unset(CMKR_SOURCES)
endif()

# Target testing
if(ZASM_BUILD_TESTS) # tests
	set(CMKR_TARGET testing)
	set(testing_SOURCES "")

	list(APPEND testing_SOURCES
		"src/testing/testing.cpp"
	)

	list(APPEND testing_SOURCES
		cmake.toml
	)

	set(CMKR_SOURCES ${testing_SOURCES})
	add_executable(testing)

	if(testing_SOURCES)
		target_sources(testing PRIVATE ${testing_SOURCES})
	endif()

	get_directory_property(CMKR_VS_STARTUP_PROJECT DIRECTORY ${PROJECT_SOURCE_DIR} DEFINITION VS_STARTUP_PROJECT)
	if(NOT CMKR_VS_STARTUP_PROJECT)
		set_property(DIRECTORY ${PROJECT_SOURCE_DIR} PROPERTY VS_STARTUP_PROJECT testing)
	endif()

	source_group(TREE ${CMAKE_CURRENT_SOURCE_DIR} FILES ${testing_SOURCES})

	target_link_libraries(testing PRIVATE
		zasm::zasm
	)

	unset(CMKR_TARGET)
	unset(CMKR_SOURCES)
endif()

enable_testing()

if(ZASM_BUILD_TESTS) # tests
	add_test(
		NAME
			tests
		WORKING_DIRECTORY
			"${CMAKE_CURRENT_LIST_DIR}/"
		COMMAND
			$<TARGET_FILE:tests>
	)

endif()
